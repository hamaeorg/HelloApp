pipeline:
  agent:
    node:
      label: 'java-build-node-3'
  environment:
    DOCKER: credentials('docker-login')
    ECR: '632014178293.dkr.ecr.eu-north-1.amazonaws.com'
    VERSION: '0.0.4'
  stages:
    - stage: "worskpace cleanup"
      steps:
        - sh "rm -rf *"
    - stage: 'Build java application'
      steps:
        - sh "git clone https://github.com/hamaeorg/HelloApp.git"
        - sh "ls"
        - sh "chmod +x ./HelloApp/HelloApp/gradlew"
        - sh "./HelloApp/HelloApp/gradlew -p HelloApp/HelloApp/ build '-PappVersion=${VERSION}' --no-daemon"
    - stage: 'containerize application'
      steps:
        - sh "cd HelloApp && sudo docker build --build-arg VERSION=${VERSION} -t hello ."
        - sh "sudo docker tag hello:latest ${ECR}/hello:${VERSION}"
        - sh "sudo docker images"
    - stage: 'push image to registry'
      steps:
        - sh "sudo docker login -u ${DOCKER_USR} -p ${DOCKER_PSW} ${ECR}"
        - sh "sudo docker push ${ECR}/hello:${VERSION}"