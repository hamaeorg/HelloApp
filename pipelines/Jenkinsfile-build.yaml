pipeline:
  agent:
    node:
      label: 'java-build-node-3'
  environment:
    ECR: credentials('aws-ECR')
    VERSION: '0.0.3'
  stages:
    - stage: "worskpace cleanup"
      steps:
        - sh "rm -rf *"
    - stage: 'Build java application'
      steps:
        - sh "git clone https://github.com/hamaeorg/HelloApp.git"
        - sh "ls"
        - sh "chmod +x ./HelloApp/HelloApp/gradlew"
        - sh "./HelloApp/HelloApp/gradlew -p HelloApp/HelloApp/ build '-PappVersion=${VERSION}' --no-daemon"
    - stage: 'containerize application'
      steps:
        - sh "cd HelloApp && sudo docker build --build-arg VERSION=${VERSION} -t hello ."
        - sh "sudo docker tag hello:latest 632014178293.dkr.ecr.eu-north-1.amazonaws.com/hello:'${VERSION}'"
        - sh "sudo docker images"
    - stage: 'push image to registry'
      steps:
        - sh "sudo aws configure set aws_access_key_id '${ECR_USR}'"
        - sh "sudo aws configure set aws_secret_access_key '${ECR_PSW}'"
        - sh "sudo aws configure set region 'eu-north-1'"
        - sh "sudo aws configure set output 'json'"
        - sh "sudo aws ecr get-login-password --region eu-north-1 | sudo docker login --username AWS --password-stdin 632014178293.dkr.ecr.eu-north-1.amazonaws.com"
        - sh "sudo docker push 632014178293.dkr.ecr.eu-north-1.amazonaws.com/hello:'${VERSION}'"